# 开发进度日志 - 2024-05-23

## 任务目标
打通“视频流获取”链路，从简单的 HTTP 控制升级为 Moonlight 完整协议栈，为后续 AI 分析做准备。

## 已完成工作

1.  **核心依赖集成**：
    *   引入了 `moonlight-common-c` (核心协议) 和 `moonlight-core` (JNI封装)。
    *   引入了 `libopus` 和 `openssl` 的预编译库。
    *   编写了 `CMakeLists.txt`，成功编译出 `libmoonlight-core.so`。解决了 `cpu-features.h`, `rs.h`, `socklen_t` 以及 Opus 链接错误。

2.  **Java 协议层移植**：
    *   从 Moonlight Android 源码中移植了关键的 Java 类：`NvHTTP`, `PairingManager`, `ConnectionContext`, `StreamConfiguration` 等。
    *   修改了 `CryptoUtils` 以适配 `LimelightCryptoProvider` 接口，复用了现有的证书管理逻辑。

3.  **业务逻辑重构**：
    *   **StreamingActivity**：彻底重写。移除旧的简易实现，改为使用官方 `NvHTTP` 进行主机发现、配对和 `/launch` 请求。
    *   **GameActivity**：初步实现。从 `GlobalContext` 获取连接参数，调用 `MoonBridge.startConnection` 启动 RTSP/RTP 链路。
    *   **GlobalContext**：创建单例，用于在 Activity 间传递复杂的 `ConnectionContext` 对象。

## 下一步计划 (Next Steps)

### 验证阶段
1.  **真机运行**：在手机上运行 App，连接 PC 端的 Sunshine。
2.  **观察日志**：关注 Logcat，确认 `Connection Started` 日志出现。此时屏幕应该是黑的（因为没有解码器），但连接不应断开或崩溃。

### 开发阶段 (阶段三)
1.  **实现解码器**：在 `GameActivity` 中，实现 `VideoDecoderRenderer` 接口。
2.  **MediaCodec 集成**：使用 Android `MediaCodec` 接收 `submitDecodeUnit` 传入的 H.264 数据并解码。
3.  **画面渲染**：将解码后的画面渲染到 SurfaceView 上。

## 给 AI 助手的交接备注
你好，未来的 AI 助手。当前项目处于 **“连接已打通，画面待解码”** 的状态。
- **关键代码**：`StreamingActivity.kt` (Launch逻辑), `GameActivity.kt` (连接启动), `app/src/main/cpp` (底层协议)。
- **编译注意**：如果遇到 C++ 链接错误，请检查 `app/src/main/cpp/moonlight-core/libopus` 下是否有预编译的 `.a` 文件。
- **当前任务**：如果用户反馈黑屏但连接成功，请开始着手编写 `VideoDecoderRenderer` 的具体实现（目前是空的）。
